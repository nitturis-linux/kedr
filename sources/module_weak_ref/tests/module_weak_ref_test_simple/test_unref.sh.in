#!/bin/sh

module_a_name="module_weak_ref_test_simple_a"
module_a="@CMAKE_CURRENT_BINARY_DIR@/module_a/${module_a_name}.ko"
module_c="@CMAKE_CURRENT_BINARY_DIR@/module_c/module_weak_ref_test_simple_c.ko"
current_value_file=/sys/module/${module_a_name}/parameters/current_value

insmod "$module_a"
if test $? -ne 0; then
    printf "Cannot load module 'a' into kernel.\n"
    exit 1
fi

insmod "$module_c"
if test $? -ne 0; then
    printf "Cannot load module 'c' into kernel.\n"
    rmmod "$module_a"
    exit 1
fi

current_value_before=`cat "$current_value_file"`

rmmod "$module_c"
if test $? -ne 0; then
    printf "Fail to unload module 'c'.\n"
    rmmod "$module_a"
    exit 1
fi

current_value_after=`cat "$current_value_file"`

rmmod "$module_a"
if test $? -ne 0; then
    printf "Fail to unload module 'a'.\n"
    exit 1
fi

if test "$current_value_before" != "5"; then
    printf "Expected, that after loading module c 'current_value' will be '5', but it is '%s'" "$current_value_before"
    exit 1
fi

if test "$current_value_after" != "5"; then
    printf "Expected, that after unloading module c 'current_value' remain to be '5', but it is '%s'" "$current_value_after"
    exit 1
fi