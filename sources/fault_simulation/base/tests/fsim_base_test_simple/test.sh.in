#! /bin/sh

module_name="kedr_fsim_base_test_simple"
module="@CMAKE_CURRENT_BINARY_DIR@/${module_name}.ko"
fsim_base_module="@CMAKE_CURRENT_BINARY_DIR@/../../kedr_fsim_base.ko"
result_file="/sys/module/$module_name/parameters/result"

insmod $fsim_base_module
if test $? -ne 0; then
    printf "Cannot load fault simulation base module into kernel.\n"
    exit 1
fi

insmod $module
if test $? -ne 0; then
    printf "Cannot load module for test into kernel.\n"
    rmmod $fsim_base_module
    exit 1
fi

result=`cat $result_file`

rmmod $module
if test $? -ne 0; then
    printf "Fail to unload module for test.\n"
    rmmod $fsim_base_module
    exit 1
fi

rmmod $fsim_base_module
if test $? -ne 0; then
    printf "Fail to unload fault simulation base module.\n"
    exit 1
fi

if test "$result" != "Ok"; then
    printf "Expected that function set result parameter to \"Ok\", but it is \"%s\".\n" "$result"
    exit 1
fi
