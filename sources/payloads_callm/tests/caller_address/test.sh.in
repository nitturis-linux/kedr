#!/bin/sh

control_script="sh @CMAKE_BINARY_DIR@/tools/control/kedr_test"

capture_trace_script="@CMAKE_BINARY_DIR@/tools/capture_trace/kedr_test_capture_trace"

tmpdir="@KEDR_TEST_PREFIX_TEMP_SESSION@/caller_address"
trace_file="${tmpdir}/trace"
debugfs_mount_point="${tmpdir}/debugfs"

if ! mkdir -p ${tmpdir}; then
	printf "Cannot create directory for tests.\n"
	exit 1
fi

target_module_script="sh @CMAKE_BINARY_DIR@/examples/sample_target/kedr_sample_target"

commands_file="${tmpdir}/commands"
do_commands_script="sh @CMAKE_BINARY_DIR@/tests/scripts/do_commands.sh"



cat > "$commands_file" << eof

on_load ${control_script} start kedr_sample_target || ! printf "Cannot start KEDR.\n"
on_unload ${control_script} stop || ! printf "Cannot stop KEDR.\n"

on_load mkdir -p ${debugfs_mount_point}
on_load mount -t debugfs debugfs "${debugfs_mount_point}" || ! printf "Cannot mount debugfs into '${debugfs_mount_point}'.\n"
on_unload umount "${debugfs_mount_point}" || ! printf "Error occures while umount debugfs.\n"

# Clear trace collected previously
on_load rm -f ${trace_file}

eof

if ! ${do_commands_script} "$commands_file" load; then
	printf "Cannot initialize test.\n"
	exit 1
fi

if ! ${target_module_script} load; then
	printf "Cannot load target module for test.\n"
	${do_commands_script} "$commands_file" unload
	exit 1
fi

# Do something with target_module for collect trace.
echo 1 > /dev/cfake

# Need for correct work of capture_trace_script
#sleep 0.2

${target_module_script} unload

${capture_trace_script} -s -d "${debugfs_mount_point}" -f "${trace_file}"

if ! ${do_commands_script} "$commands_file" unload; then
	printf "Error occures while finalize test.\n"
	exit 1
fi

# Verification of the trace
cat "$trace_file" | grep -F "unknown+0x"
if test $? -eq 0; then
	printf "Resolving of some of the caller addresses was failed. See file '%s'.\n" "${trace_file}"
	exit 1
fi